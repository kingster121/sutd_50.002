/*
    This file was generated automatically by Alchitry Labs 2.0.24-BETA.
    Do not edit this file directly. Instead edit the original Lucid source.
    This is a temporary file and any changes made to it will be destroyed.
*/

module pwm #(
        parameter WIDTH = 4'h8,
        parameter TOP = 1'h0,
        parameter DIV = 1'h0
    ) (
        input wire clk,
        input wire rst,
        input wire [(WIDTH)-1:0] value,
        input wire update,
        output reg pulse
    );
    localparam _MP_SIZE_987870138 = WIDTH;
    localparam _MP_DIV_987870138 = DIV;
    localparam _MP_TOP_987870138 = TOP;
    localparam _MP_UP_987870138 = 1'h1;
    logic [(_MP_SIZE_987870138)-1:0] M_ctr_value;
    
    counter #(
        .SIZE(_MP_SIZE_987870138),
        .DIV(_MP_DIV_987870138),
        .TOP(_MP_TOP_987870138),
        .UP(_MP_UP_987870138)
    ) ctr (
        .clk(clk),
        .rst(rst),
        .value(M_ctr_value)
    );
    
    
    logic [(WIDTH)-1:0] D_cur_value_d, D_cur_value_q = 0;
    logic D_need_update_d, D_need_update_q = 0;
    logic [(WIDTH)-1:0] D_next_value_d, D_next_value_q = 0;
    always @* begin
        D_cur_value_d = D_cur_value_q;
        D_need_update_d = D_need_update_q;
        D_next_value_d = D_next_value_q;
        
        if (!(|M_ctr_value) && D_need_update_q) begin
            D_cur_value_d = D_next_value_q;
            D_need_update_d = 1'h0;
        end
        if (update) begin
            D_next_value_d = value;
            D_need_update_d = 1'h1;
        end
        pulse = M_ctr_value < D_cur_value_q;
    end
    
    
    always @(posedge (clk)) begin
        if ((rst) == 1'b1) begin
            D_cur_value_q <= 0;
            D_need_update_q <= 0;
        end else begin
            D_cur_value_q <= D_cur_value_d;
            D_need_update_q <= D_need_update_d;
        end
    end
    always @(posedge (clk)) begin
        D_next_value_q <= D_next_value_d;
        
    end
endmodule